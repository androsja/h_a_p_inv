services:

  # ─── Bot simulado ────────────────────────────────────────────────────────────
  trading-bot-sim:
    build:
      context: .
      dockerfile: Dockerfile
    image: hapi-scalping-bot:latest
    container_name: hapi_bot_simulated
    restart: unless-stopped
    env_file: .env
    environment:
      - TRADING_MODE=SIMULATED
      - HAPI_IS_TEST_MODE=true
    command: [ "python", "simulation_mode/main_sim.py" ]
    volumes:
      - ./simulation_mode:/app/simulation_mode
      - ./data:/app/data
      - ./logs:/app/logs
      - ./shared:/app/shared
      - ./shared/assets_sim.json:/app/assets_sim.json
      - ./shared/assets_live.json:/app/assets_live.json
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "256M"
    healthcheck:
      test: [ "CMD", "python", "-c", "import sys; sys.exit(0)" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─── Dashboard en tiempo real ────────────────────────────────────────────────
  dashboard:
    build:
      context: .
      dockerfile: dashboard/Dockerfile
    image: hapi-dashboard:latest
    container_name: hapi_dashboard
    restart: unless-stopped
    env_file: .env
    ports:
      - "8080:8080" # → Abrir http://localhost:8080
    volumes:
      - ./dashboard:/app/dashboard
      - ./data:/app/data
      - ./logs:/app/logs
      - ./shared:/app/shared
      - ./shared/assets_sim.json:/app/assets_sim.json
      - ./shared/assets_live.json:/app/assets_live.json
    depends_on:
      - trading-bot-sim
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/api/state')" ]
      interval: 15s
      timeout: 5s
      retries: 3

  # ─── Bot LIVE (activar con: docker compose --profile live up) ────────────────
  trading-bot-live:
    build:
      context: .
      dockerfile: Dockerfile
    image: hapi-scalping-bot:latest
    container_name: hapi_bot_live
    restart: unless-stopped
    profiles: [ live ]
    env_file: .env
    environment:
      - TRADING_MODE=LIVE
      - HAPI_IS_TEST_MODE=false
    command: [ "python", "live_mode/main_live.py" ]
    volumes:
      - ./live_mode:/app/live_mode
      - ./data:/app/data
      - ./logs:/app/logs
      - ./shared/assets_live.json:/app/assets_live.json
      - ./shared/data/market_data.py:/app/shared/data/market_data.py
      - ./shared/broker:/app/broker
      - ./shared/strategy:/app/strategy
      - ./shared/utils:/app/utils
      - ./shared/config.py:/app/config.py
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: "512M"

  # ─── Bot LIVE PAPER (datos reales, dinero ficticio) ─────────────────────────
  trading-bot-paper:
    build:
      context: .
      dockerfile: Dockerfile
    image: hapi-scalping-bot:latest
    container_name: hapi_bot_paper
    restart: unless-stopped
    profiles: [ paper ]
    env_file: .env
    environment:
      - TRADING_MODE=LIVE
      - HAPI_IS_TEST_MODE=true
    command: [ "python", "live_mode/main_live.py", "--paper" ]
    volumes:
      - ./live_mode:/app/live_mode
      - ./data:/app/data
      - ./logs:/app/logs
      - ./shared/assets_live.json:/app/assets_live.json
      - ./shared/data/market_data.py:/app/shared/data/market_data.py
      - ./shared/broker:/app/broker
      - ./shared/strategy:/app/strategy
      - ./shared/utils:/app/utils
      - ./shared/config.py:/app/config.py
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: "512M"

# ─── Volúmenes compartidos ────────────────────────────────────────────────────
# (Usando bind mounts directos para mayor transparencia)
